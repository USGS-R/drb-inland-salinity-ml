---
title: "Explore_Area_Diff_LandUse"
author: "Margaux"
date: "3/31/2022"
output: html_document
---

```{r}

```


```{r}
library(dplyr)
library(tidyverse)
library(nhdplusTools)
library(mapview)

```

```{r}

# Comparing PRMS NLCD proportions dataset wih FORESCE
targets::tar_make(p2_PRMS_NLCD_lc_proportions_reclass_cat)
targets::tar_make(p2_FORESCE_LC_per_catchment_reclass_cat)
targets::tar_load(p2_PRMS_NLCD_lc_proportions_reclass_cat)
targets::tar_load(p2_FORESCE_LC_per_catchment_reclass_cat)

```

###----

```{r}

# subset/filter and mutate. We choose year 2000 for FORESCE and 2001 for NLCD

##2000
l1 <- p2_FORESCE_LC_per_catchment_reclass_cat[[7]] %>%
  #  select(PRMS_segid, Year, everything(), -hru_segment) %>% 
  mutate(total_PRMS_area_km2 = total_PRMS_area/10^6) %>%
  select(PRMS_segid, total_PRMS_area_km2)
## 2001
l2 <- p2_PRMS_NLCD_lc_proportions_reclass_cat[[1]] %>%
  # select(PRMS_segid, Year, everything(), -AREASQKM_PRMS) %>% 
  select(PRMS_segid, AREASQKM_PRMS)

head(l1)
head(l2)

```

```{r}
# Merge l1 and l2 and calculate different for each PRMS SEGMENT
df <- l1 %>% left_join(l2, by = 'PRMS_segid') %>% 
  rename(PRMS_area_km2_FOR = total_PRMS_area_km2, PRMS_area_km2_NLCD = AREASQKM_PRMS) %>% 
  mutate(ab_diff = abs(PRMS_area_km2_FOR - PRMS_area_km2_NLCD)) %>%
  mutate(ab_diff_categorized = factor(case_when(ab_diff > 50 ~ '>50 km2',
                              ab_diff > 10 ~ '>10 km2',
                              ab_diff > 5 ~ '>5 km2',
                              ab_diff >1 ~ '>1 km2',
                              TRUE ~ '< 1 km2'),
                              levels = c('< 1 km2', '>1 km2', '>5 km2', '>10 km2', '>50 km2'))) 


dim(df)

```

```{r}

## Plotting
scatterplot1 <- ggplot(df, aes(y = PRMS_area_km2_FOR, x = PRMS_area_km2_NLCD))+
  geom_point(aes(color = ab_diff_categorized))+theme_bw()+
  ylab('PRMS Cat Area - geopackage')+
  xlab('PRMS Cat Area - nhd catchment aggregation')+
  labs(caption = 'Scatter plot of PRMS area in the NLCD dataset versus FORESCE.\n Point colored by their difference categories')+
  theme(plot.caption = element_text(hjust = 0.5))
scatterplot1  

```

```{r}
bar_plot_diff_bins <- ggplot(df, aes(x = ab_diff_categorized))+
  geom_bar(fill = 'lightblue4')+
  scale_y_continuous(n.breaks = 15)+
  theme_bw()+
  labs(caption ='\n Ab difference between area (km2) of FORESCE land use prop dataset\n (2000) and NLCD land use dataset (2001) grouped into 4 categories')+
  theme(plot.caption = element_text(hjust = 0.5))
bar_plot_diff_bins

```

###----

```{r}
# Check whether incorrect comids have comids of area 0
targets::tar_make(p2_NLCD_LC_w_catchment_area)
targets::tar_load(p2_NLCD_LC_w_catchment_area)

## subset the source dataset for NLCD w/ area 
PRMS_areasqkm_0 <- p2_NLCD_LC_w_catchment_area %>%
  filter(AREASQKM == 0) %>% select(PRMS_segid, comid, AREASQKM)
PRMS_areasqkm_0
# 
PRMS_areasqkm_0 %>% 
       mutate(incorrect = case_when(PRMS_segid %in%
                                      comids_over_50_km2$PRMS_segid ~ "TRUE",
                                    TRUE ~ 'FALSE')) %>% 
  filter(incorrect == TRUE)
     
```

###----
```{r}
## Extract rows that are problematic
over_50_km2 <- df %>% filter(ab_diff_categorized == '>50 km2') %>% select(PRMS_segid)
over_10_km2 <- df %>% filter(ab_diff_categorized == '>10 km2') %>% select(PRMS_segid)

## Pulling target that maps all comids within each PRMS
targets::tar_make(p2_drb_comids_all_tribs)
targets::tar_load(p2_drb_comids_all_tribs)

## subsetting to the comids that have differing areas
comids_over_50_km2 <- p2_drb_comids_all_tribs %>%
  filter(PRMS_segid %in% over_50_km2$PRMS_segid)
comids_over_50_km2

```

```{r}
## Grob comids 
all_comids <- get_nhdplus(comid = comids_over_50_km2$comid, realization = 'catchment') %>% 
  mutate(featureid = as.character(featureid))
head(all_comids)

comids_over_50_km2 <- comids_over_50_km2 %>%
  left_join(all_comids, by= c('comid' = 'featureid'),
            keep = TRUE)

```

```{r}
## Assess specific PRMS_segid - 12_1
subsetted_comids_over_50km2 <- comids_over_50_km2 %>% filter(PRMS_segid == '12_1')
catchment <- p1_catchments_edited_sf %>% filter(PRMS_segid == unique(subsetted_comids_over_50km2$PRMS_segid))
reach <- p1_reaches_sf %>% filter(subsegid == unique(subsetted_comids_over_50km2$PRMS_segid))
                                  
mapview(subsetted_comids_over_50km2$geometry,
        col.regions = 'red', alpha.regions = 0.5) +
  mapview(catchment)+ mapview(reach, color = 'black')

```

## 157_1
subsetted_comids_over_50km2 <- comids_over_50_km2 %>% filter(PRMS_segid == '157_1')
catchment <- p1_catchments_edited_sf %>% filter(PRMS_segid == unique(subsetted_comids_over_50km2$PRMS_segid))
reach <- p1_reaches_sf %>% filter(subsegid == unique(subsetted_comids_over_50km2$PRMS_segid))

mapview(subsetted_comids_over_50km2$geometry,
        col.regions = 'red', alpha.regions = 0.5) +
  mapview(catchment)+ mapview(reach, color = 'black')

## 216_1
subsetted_comids_over_50km2 <- comids_over_50_km2 %>% filter(PRMS_segid == '216_1')
catchment <- p1_catchments_edited_sf %>% filter(PRMS_segid == unique(subsetted_comids_over_50km2$PRMS_segid))
reach <- p1_reaches_sf %>% filter(subsegid == unique(subsetted_comids_over_50km2$PRMS_segid))

mapview(subsetted_comids_over_50km2$geometry,
        col.regions = 'red', alpha.regions = 0.5) +
  mapview(catchment)+ mapview(reach, color = 'black')

## 878_1
subsetted_comids_over_50km2 <- comids_over_50_km2 %>% filter(PRMS_segid == '878_1')
catchment <- p1_catchments_edited_sf %>% filter(PRMS_segid == unique(subsetted_comids_over_50km2$PRMS_segid))
reach <- p1_reaches_sf %>% filter(subsegid == unique(subsetted_comids_over_50km2$PRMS_segid))

mapview(subsetted_comids_over_50km2$geometry,
        col.regions = 'red', alpha.regions = 0.5) +
  mapview(catchment)+ mapview(reach, color = 'black')

## 386_1
subsetted_comids_over_50km2 <- comids_over_50_km2 %>% filter(PRMS_segid == '386_1')
catchment <- p1_catchments_edited_sf %>% filter(PRMS_segid == unique(subsetted_comids_over_50km2$PRMS_segid))
reach <- p1_reaches_sf %>% filter(subsegid == unique(subsetted_comids_over_50km2$PRMS_segid))

mapview(subsetted_comids_over_50km2$geometry,
        col.regions = 'red', alpha.regions = 0.5) +
  mapview(catchment)+ mapview(reach, color = 'black')

comids_386_1 <- p2_drb_comids_all_tribs %>% filter(PRMS_segid =='386_1')
comids_387_1 <- p2_drb_comids_all_tribs %>% filter(PRMS_segid =='387_1')

## Polygon is the same 
PRMS_catchments_386_387 <- p1_catchments_edited_sf[p1_catchments_edited_sf$PRMS_segid %in% c('386_1','387_1'),]

mapview(get_nhdplus(comid = comids_386_1$comid, realization = 'catchment'))+
  mapview(get_nhdplus(comid = comids_387_1$comid, realization = 'catchment'), col.regions = 'red')+
  mapview(PRMS_catchments_386_387, col.regions = 'green')

## Assess specific PRMS_segid
PRMS_12_1 <- comids_over_50_km2 %>% filter(PRMS_segid == '12_1')

mapview(PRMS_12_1$geometry, col.regions = 'red', alpha.regions = 0.5) +
  mapview(p1_catchments_edited_sf %>% filter(PRMS_segid == unique(PRMS_12_1$PRMS_segid)))

PRMS_areasqkm_0 <- unique(p2_NLCD_LC_w_catchment_area %>% filter(TOTDASQKM == 0) %>% select(PRMS_segid))

View(PRMS_areasqkm_0 %>% mutate(incorrect = case_when(
  PRMS_segid %in% comids_over_50_km2$PRMS_segid ~ "TRUE", TRUE ~ 'FALSE')))



# Check areas of upstream targets used to generate the land use targets above. 

targets::tar_load(p1_catchments_edited_sf)
targets::tar_load(p2_NLCD_LC_w_catchment_area)

t1 <- p2_NLCD_LC_w_catchment_area %>% group_by(PRMS_segid) %>% 
  summarise(PRMS_area_km2 = sum(AREASQKM))

t2 <- p1_catchments_edited_sf %>% sf::st_drop_geometry() %>% 
  group_by(PRMS_segid) %>% summarise(PRMS_area_km2 = sum(hru_area_m2)/10^6)


df_2 <- t1 %>% left_join(t2, by = 'PRMS_segid') %>% 
  mutate(ab_diff = abs(PRMS_area_km2.x - PRMS_area_km2.y)) %>%
  mutate(ab_diff_categorized = factor(case_when(ab_diff > 50 ~ '>50 km2',
                                                ab_diff > 10 ~ '>10 km2',
                                                ab_diff > 5 ~ '>5 km2',
                                                ab_diff >1 ~ '>1 km2',
                                                TRUE ~ '< 1 km2'),
                                      levels = c('< 1 km2', '>1 km2', '>5 km2', '>10 km2', '>50 km2'))) 

ggplot(df_2, aes(x = ab_diff_categorized))+
  geom_bar()+
  scale_y_continuous(n.breaks = 15)+theme_bw()+
  labs(caption ='\n Ab difference between area (km2) of catchment polygons in p1_catchments_edited_sf and xwalk area from land use prop dataset\n (2000) and NLCD land use dataset (2001) grouped into 4 categories')

```
